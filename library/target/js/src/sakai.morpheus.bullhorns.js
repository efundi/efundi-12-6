(function(c){if((typeof qtip!=="object"&&typeof moment!=="object"&&typeof portal!=="object")||typeof moment==="undefined"){return}moment.locale(portal.locale);portal.socialBullhorn=$PBJQ("#Mrphs-social-bullhorn");portal.academicBullhorn=$PBJQ("#Mrphs-academic-bullhorn");var b=function(e){var d=moment(e);return d.format("L LT")};portal.wrapNoAlertsString=function(d){return'<div class="portal-bullhorn-no-alerts">'+d+"</div>"};portal.clearBullhornAlert=function(e,f,d){$PBJQ.get("/direct/portal/clearBullhornAlert",{id:f}).done(function(){var g=$PBJQ("#portal-bullhorn-alert-"+f);var i=$PBJQ(".portal-bullhorn-"+e+"-alert").length===1;g.remove();if(i){$PBJQ(".portal-bullhorn-"+e+"-alerts").html(portal.wrapNoAlertsString(d))}var h=$PBJQ(".portal-bullhorn-"+e+"-alert").length;portal.setCounter(e,h)})};portal.clearAllAlerts=function(e,d){$PBJQ.ajax({url:"/direct/portal/clearAll"+e+"Alerts",cache:false}).done(function(){$PBJQ(".portal-bullhorn-"+e.toLowerCase()+"-alerts").html(portal.wrapNoAlertsString(d));portal.setCounter(e.toLowerCase(),0)})};portal.acceptFriendRequest=function(f,e,d,g){confirmFriendRequest(e,f);this.clearBullhornAlert(portal.SOCIAL,d,g)};portal.ignoreFriendRequest=function(g,e,d,f){ignoreFriendRequest(e,g);this.clearBullhornAlert(portal.SOCIAL,d,f)};$PBJQ(document).ready(function(){portal.socialBullhorn.qtip({suppress:false,position:{adjust:{scroll:false},my:"top right",at:"bottom left",target:portal.socialBullhorn},show:{event:"click",delay:0,solo:portal.academicBullhorn},style:{classes:"portal-bullhorns"},hide:{event:"click unfocus"},content:{text:function(e,d){return $PBJQ.ajax({url:"/direct/portal/socialAlerts.json",cache:false,}).then(function(g){if(g.message&&g.message==="NO_ALERTS"){return portal.wrapNoAlertsString(g.i18n.noAlerts)}else{var f='<div class="portal-bullhorn-social-alerts">';g.alerts.forEach(function(i){if(i.event==="profile.friend.request"){f+='<a href="javascript:;" class="portal-bullhorn-connectionmanager-pending">'}else{if(i.event==="profile.friend.confirm"){f+='<a href="javascript:;" class="portal-bullhorn-connectionmanager-current">'}else{f+='<a href="'+i.url+'">'}}f+='<div id="portal-bullhorn-alert-'+i.id+'" class="portal-bullhorn-social-alert"><div class="portal-bullhorn-photo" style="background-image:url(/direct/profile/'+i.from+'/image/thumb)"></div><div class="portal-bullhorn-content"><div class="portal-bullhorn-message"><span class="portal-bullhorn-display-name">'+i.fromDisplayName+"</span>";if(i.event==="profile.wall.item.new"){f+=g.i18n.wallPost}else{if(i.event==="profile.status.update"){f+=g.i18n.statusUpdate}else{if(i.event==="profile.wall.item.comment.new"){f+=g.i18n.postComment}else{if(i.event==="profile.friend.request"){f+=g.i18n.friendRequest}else{if(i.event==="profile.friend.confirm"){f+=g.i18n.friendConfirm}else{if(i.event==="profile.message.sent"){f+=g.i18n.message}else{if(i.event==="commons.comment.created"){f+=g.i18n.commentCreated}else{f+=g.i18n.unrecognisedAlert}}}}}}}var h=b(i.eventDate);f+='</div><div class="portal-bullhorn-time">'+h+'</div><div class="portal-bullhorn-options">';if(i.event==="profile.friend.request"){f+='<a href="javascript:;" onclick="portal.acceptFriendRequest(\''+i.from+"','"+i.to+"','"+i.id+"','"+g.i18n.noAlerts+"');\">"+g.i18n.accept+"</a>";f+='<a href="javascript:;" onclick="portal.ignoreFriendRequest(\''+i.from+"','"+i.to+"','"+i.id+"','"+g.i18n.noAlerts+"');\">"+g.i18n.ignore+"</a>"}f+="</div>";f+='</div><div class="portal-bullhorn-clear"><a href="javascript:;" onclick="portal.clearBullhornAlert(\'social\', \''+i.id+"','"+g.i18n.noAlerts+'\');" title="'+g.i18n.clear+'"><i class="fa fa-times" aria-hidden="true"></i></a></div></div></a>'});f+='<div id="portal-bullhorn-clear-all"><a href="javascript:;" onclick="portal.clearAllAlerts(\'Social\',\''+g.i18n.noAlerts+"');\">"+g.i18n.clearAll+"</a></div>";f+="</div>";return f}},function(h,f,g){d.set("content.text",f+": "+g)})}},events:{visible:function(e,d){$PBJQ(".portal-bullhorn-connectionmanager-pending").click(function(f){portal.connectionManager.show({state:"pending"});d.hide()});$PBJQ(".portal-bullhorn-connectionmanager-current").click(function(f){portal.connectionManager.show();d.hide()})}}});portal.academicBullhorn.qtip({suppress:false,position:{adjust:{scroll:false},my:"top right",at:"bottom left",target:portal.socialBullhorn},show:{event:"click",delay:0,solo:portal.socialBullhorn},style:{classes:"portal-bullhorns"},hide:{event:"click unfocus"},content:{text:function(e,d){return $PBJQ.ajax({url:"/direct/portal/academicAlerts.json",dataType:"json",cache:false,}).then(function(g){if(g.message&&g.message==="NO_ALERTS"){return portal.wrapNoAlertsString(g.i18n.noAlerts)}else{var f='<div class="portal-bullhorn-academic-alerts">';g.alerts.forEach(function(m){var l=m.title;var h=m.siteTitle;var k="fa-bullhorn";if(m.event==="asn.new.assignment"||m.event==="asn.grade.submission"){k="fa-file-text"}else{if(m.event==="lessonbuilder.comment.create"){k="fa-leanpub"}}f+='<a href="'+m.url+'" style="text-decoration: none;"><div id="portal-bullhorn-alert-'+m.id+'" class="portal-bullhorn-academic-alert"><div class="portal-bullhorn-icon fa fa-stack"><i class="fa fa-circle fa-stack-2x"></i><i class="fa '+k+' fa-stack-1x fa-inverse"></i></div><div class="portal-bullhorn-content"><div class="portal-bullhorn-message"><span class="portal-bullhorn-display-name">'+m.fromDisplayName+"</span>";var i="";if(m.event==="annc.new"){i=g.i18n.announcement.replace("{0}",l).replace("{1}",h)}else{if(m.event==="asn.new.assignment"){i=g.i18n.assignmentCreated.replace("{0}",l).replace("{1}",h)}else{if(m.event==="asn.grade.submission"){i=g.i18n.assignmentSubmissionGraded.replace("{0}",l).replace("{1}",h)}else{if(m.event==="commons.comment.created"){f+=g.i18n.academicCommentCreated.replace("{0}",h)}else{if(m.event==="lessonbuilder.comment.create"){f+=g.i18n.academicLessonBuilderCommentCreate.replace("{0}",h)}else{f+=g.i18n.unrecognisedAlert}}}}}var j=b(m.eventDate);f+=i+'</div><div class="portal-bullhorn-time">'+j+"</div>";f+='</div><div class="portal-bullhorn-clear"><a href="javascript:;" onclick="portal.clearBullhornAlert(\'academic\', \''+m.id+"','"+g.i18n.noAlerts+'\');" title="'+g.i18n.clear+'"><i class="fa fa-times" aria-hidden="true"></i></a></div></div></a>'});f+='<div id="portal-bullhorn-clear-all"><a href="javascript:;" onclick="portal.clearAllAlerts(\'Academic\',\''+g.i18n.noAlerts+"');\">"+g.i18n.clearAll+"</a></div>";f+="</div>";return f}},function(h,f,g){d.set("content.text",f+": "+g)})}}})});portal.setCounter=function(d,e){var g=$PBJQ("#Mrphs-"+d+"-bullhorn");var f=(d==="social")?"blue":"red";g.find(".bullhorn-counter").remove();g.append('<span class="bullhorn-counter bullhorn-counter-'+f+'">'+e+"</span>")};var a=function(){$PBJQ.ajax({url:"/direct/portal/bullhornCounts.json",cache:false,data:{auto:true}}).done(function(d){portal.failedBullhornCounts=0;if(d.academic>0){portal.setCounter("academic",d.academic)}else{portal.academicBullhorn.find(".bullhorn-counter").remove()}if(d.social>0){portal.setCounter("social",d.social)}else{portal.socialBullhorn.find(".bullhorn-counter").remove()}}).fail(function(f,d,e){console.log("Failed to get the bullhorn counts. Status: "+d);console.log("FAILED ERROR: "+e);portal.failedBullhornCounts=portal.failedBullhornCounts||0;portal.failedBullhornCounts+=1;if(portal.failedBullhornCounts==3){clearInterval(portal.bullhornCountIntervalId)}})};if(portal.loggedIn&&portal.bullhorns&&portal.bullhorns.enabled){a();portal.bullhornCountIntervalId=setInterval(a,portal.bullhorns.pollInterval)}})($PBJQ);