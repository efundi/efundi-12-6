(function(i){portal.connectionManager=portal.connectionManager||{};var n=Handlebars.templates["connection-manager-connection"];var b=Handlebars.templates["connection-manager-searchresult"];var j={};var g={};var f=function(){return Object.keys(g).length};var e={};var c={};$PBJQ(document).ready(function(){portal.i18n.loadProperties({resourceClass:"org.sakaiproject.portal.api.PortalService",resourceBundle:"connection-manager",namespace:"connection-manager",callback:function(){portal.i18n.loadProperties({resourceClass:"org.sakaiproject.portal.api.PortalService",resourceBundle:"profile-popup",namespace:"connection-manager"})}})});var l=0;var h=[];var k="connections";var o="searchresults";var a=k;var m=0;var d="";portal.connectionManager.show=function(v){var L=$PBJQ("#connection-manager");L.modal({width:320});var J=$PBJQ("#connection-manager-connectionsview");var w=$PBJQ("#connection-manager-searchresultsview");var t=$PBJQ("#connection-manager-searchresultsview-count");var O=$PBJQ("#connection-manager-navbar-current > span > a");var D=$PBJQ("#connection-manager-navbar-pending > span > a");var T=function(X){if(X===0){t.html(portal.i18n.tr("connection-manager","connection_manager_no_results"))}else{var W={count:X,criteria:portal.connectionManager.searchCriteria};var Y=(X>1)?portal.i18n.tr("connection-manager","connection_manager_results_count",W):portal.i18n.tr("connection-manager","connection_manager_result_count",W);t.html(Y)}};var q=function(){M.hide();P.show();J.show();w.hide();O.parent().addClass("current");D.parent().removeClass("current")};var N=function(){P.hide();M.show();J.show();w.hide();D.parent().addClass("current");O.parent().removeClass("current")};var s=function(Z,W){var aa=f();$PBJQ("#connection-manager-connection-"+Z).remove();$PBJQ("#connection-manager-connectionsview-searchresult-"+Z).remove();if(G.children().length===0){C.hide()}var Y=e[Z];Y.connected=false;Y.hideConnect=true;Y.outgoing=true;g[Z]=Y;var X=n(Y);if(aa===0){K.show().html("");V.hide()}K.append(X);A();if(a===k||(a==o&&x.children().length===0)){N()}$PBJQ("#connection-manager-cancel-button-"+Z).click(I)};O.click(function(W){q()});D.click(function(W){N()});var C=$PBJQ("#connection-manager-connectionsview-searchresults-wrapper");var G=$PBJQ("#connection-manager-connectionsview-searchresults");var x=$PBJQ("#connection-manager-searchresultsview-results");L.click(function(Y){if(Y.target.id!=="connection-manager-connectionsview-searchbox"){var X=C[0].getBoundingClientRect();var W=z[0].getBoundingClientRect();if(Y.pageX<X.left||Y.pageY<X.top||Y.pageX>(X.left+X.width)||Y.pageY>(X.top+X.height)){C.hide()}}});var B=$PBJQ("#connection-manager-current-connections");var P=$PBJQ("#connection-manager-current-connections-wrapper");var p=$PBJQ("#connection-manager-no-current-connections-wrapper");var K=$PBJQ("#connection-manager-pending-connections");var M=$PBJQ("#connection-manager-pending-connections-wrapper");var V=$PBJQ("#connection-manager-no-pending-connections-wrapper");var z=$PBJQ("#connection-manager-connectionsview-searchbox");z.clearSearch({callback:function(){C.hide()}});var U=$PBJQ("#connection-manager-searchresultsview-searchbox");if(m==0){d=D.html();m+=1}var S=function(Y){$PBJQ("#connection-manager-connection-"+Y).remove();if(l==0){B.html("")}var X=g[Y];X.outgoing=false;X.incoming=false;X.connected=true;var W=n(X);B.append(W);l+=1;$PBJQ("#connection-manager-remove-button-"+Y).click(Q);p.hide();delete g[Y];j[Y]=X;A();q()};var r=function(){var X=this.dataset.userId;var W=this.dataset.displayName;$PBJQ.ajax("/direct/profile/"+portal.user.id+"/confirmFriendRequest?friendId="+X,{cache:false}).done(function(Y){S(X)}).fail(function(Y,aa,Z){console.log("ERROR: failed to confirm request from '"+W+"'. errorThrown: "+Z)})};var F=function(W){$PBJQ(".connection-manager-connection-"+W).remove();delete g[W];A()};var y=function(){var X=this.dataset.userId;var W=this.dataset.displayName;$PBJQ.ajax("/direct/profile/"+portal.user.id+"/ignoreFriendRequest?friendId="+X,{cache:false}).done(function(Y){F(X)}).fail(function(Y,aa,Z){console.log("ERROR: failed to ignore request from '"+W+"'. errorThrown: "+Z)})};var E=function(){var X=this.dataset.userId;var W=this.dataset.displayName;$PBJQ.ajax("/direct/profile/"+portal.user.id+"/requestFriend?friendId="+X,{cache:false}).done(function(Y){s(X,W)}).fail(function(Y,aa,Z){console.log("ERROR: failed to request connection to '"+W+"'. errorThrown: "+Z)})};var R=function(W){$PBJQ("#connection-manager-connection-"+W).remove();l-=1;if(l==0){p.show()}delete j[W]};var Q=function(){var X=this.dataset.userId;var W=this.dataset.displayName;if(confirm(portal.i18n.tr("connection-manager","connection_manager_remove_confirm",{displayName:W}))){$PBJQ.ajax("/direct/profile/"+portal.user.id+"/removeFriend?friendId="+X,{cache:false}).done(function(Y){R(X)}).fail(function(Y,aa,Z){console.log("ERROR: failed to remove '"+W+"'. errorThrown: "+Z)})}};var I=function(){var X=this.dataset.userId;var W=this.dataset.displayName;$PBJQ.ajax("/direct/profile/"+X+"/ignoreFriendRequest?friendId="+portal.user.id,{cache:false}).done(function(Y){$PBJQ(".connection-manager-connection-"+X).remove();delete g[X];A()}).fail(function(Y,aa,Z){console.log("ERROR: failed to ignore request from '"+W+"'. errorThrown: "+Z)})};var A=function(){var W=f();if(W===0){D.html(d);K.html("").hide();V.show()}else{D.html(d+" ("+W+")")}};var H=function(Z,X){var W=(X)?x:G;if(Z.length<4){W.html("");if(!X){C.hide()}else{T(0)}return}portal.connectionManager.searchCriteria=Z;var Y=(X)?n:b;$PBJQ.ajax("/direct/portal/connectionsearch.json?query="+Z,{cache:false}).done(function(ab){W.html("");if(ab.length===0){if(!X){C.hide()}return}if(!X){C.show()}var aa="";c=ab;e={};c.forEach(function(ac){e[ac.uuid]=ac});if(X){c.forEach(function(ac,ad){aa+=Y(ac)})}else{c.slice(0,5).forEach(function(ac,ad){aa+=Y(ac)})}if(X){T(c.length)}W.html(aa);if(W.children().length>0){W.show()}$PBJQ(document).ready(function(){if(!X){profile.attachPopups($PBJQ(".profile-popup"),{connect:s,cancel:F,accept:S,ignore:F,remove:R})}else{$PBJQ(".connection-manager-connect-button").click(E)}$PBJQ("#connection-manager-connectionsview-searchresults-more").click(function(ac){a=o;G.html("");C.hide();J.hide();w.show();U.val(portal.connectionManager.searchCriteria);z.val("");$PBJQ(document).ready(function(){T(c.length);var ad="";c.forEach(function(ae,af){ae.facebookSet=ae.socialNetworkingInfo.facebookUrl;ae.twitterSet=ae.socialNetworkingInfo.twitterUrl;ae.moreResult=true;if(j.hasOwnProperty(ae.uuid)){ae.connected=true;ae.hideConnect=true}if(g.hasOwnProperty(ae.uuid)){ae.connected=false;ae.hideConnect=true;ae.outgoing=g[ae.uuid].outgoing;ae.incoming=g[ae.uuid].incoming}ad+=n(ae)});x.html(ad);$PBJQ(document).ready(function(){$PBJQ(".connection-manager-accept-button").click(r);$PBJQ(".connection-manager-ignore-button").click(y);$PBJQ(".connection-manager-connect-button").click(E);$PBJQ(".connection-manager-remove-button").click(Q);$PBJQ(".connection-manager-cancel-button").click(I)})})});$PBJQ("#connection-manager-backtoconnections-link").click(function(ac){a=k;w.hide();J.show();C.hide();G.html("");z.val("")})})})};$PBJQ.ajax("/direct/profile/"+portal.user.id+"/connections.json",{cache:false}).done(function(W){j={};l=W.length;searchUserIdFilter=[portal.user.id];B.html("");h=W;if(h.length==0){p.show()}else{p.hide()}W.forEach(function(X){X.facebookSet=X.socialNetworkingInfo.facebookUrl;X.twitterSet=X.socialNetworkingInfo.twitterUrl;X.current=true;X.connected=true;X.incoming=false;X.hideConnect=true;j[X.uuid]=X;B.append(n(X))});$PBJQ(document).ready(function(){$PBJQ(".connection-manager-remove-button").click(Q)})}).fail(function(W,Y,X){console.log("ERROR: failed to get current connections. errorThrown: "+X)});var u=function(W){if(W.length==0){V.show();K.hide()}else{V.hide();K.show().html("")}W.forEach(function(X){X.hideConnect=true;X.pending=true;K.append(n(X));g[X.uuid]=X});if(W.length>0){D.html(d+" ("+W.length+")")}else{D.html(d)}$PBJQ(document).ready(function(){$PBJQ(".connection-manager-accept-button").click(r);$PBJQ(".connection-manager-ignore-button").click(y);$PBJQ(".connection-manager-cancel-button").click(I)})};$PBJQ.ajax("/direct/profile/"+portal.user.id+"/incomingConnectionRequests.json",{cache:false}).done(function(W){g={};W.forEach(function(X){X.incoming=true});$PBJQ.ajax("/direct/profile/"+portal.user.id+"/outgoingConnectionRequests.json",{cache:false}).done(function(X){X.forEach(function(Y){Y.outgoing=true;W.push(Y)});u(W)}).fail(function(X,Z,Y){console.log("Failed to get outgoing requests. errorThrown: "+Y)})}).fail(function(W,Y,X){console.log("Failed to get incoming requests. errorThrown: "+X)});z.keyup(function(W){H(this.value,false)});z.keydown(function(W){if(W.which==13&&this.value.length>=4){$PBJQ("#connection-manager-connectionsview-searchresults-more").click()}});U.keyup(function(W){H(this.value,true)});if(v&&v.state==="pending"){N()}};$PBJQ("#Mrphs-userNav__submenuitem--connections").click(portal.connectionManager.show)})($PBJQ);