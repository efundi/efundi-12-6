var selectSiteModalLinks,selectSiteLastModalInTab;var dhtml_view_sites=function(){$PBJQ("#selectSiteModal").addClass("dhtml_more_tabs");$PBJQ(".more-tab").position();var a=$PBJQ(window).height()*0.8;dhtml_view_sites=function(){var e=$PBJQ("#selectSiteModal");e.show();if(typeof selectSiteModalLinks=="undefined"||typeof selectSiteLastModalInTab=="undefined"){selectSiteModalLinks=e.find("button, a");selectSiteLastModalInTab=e.find(".tab-box a:last")}e.on("keydown",function(h){var g=false;if(h.ctrlKey||h.metaKey||h.altKey){return}switch(h.which){case 27:closeDrawer();g=true;break;case 9:if(h.shiftKey){if(h.target===selectSiteModalLinks[0]){selectSiteModalLinks[selectSiteModalLinks.length-1].focus();g=true}}else{if(h.target===selectSiteModalLinks[selectSiteModalLinks.length-1]||h.target===selectSiteLastModalInTab[selectSiteLastModalInTab.length-1]){selectSiteModalLinks[0].focus();g=true}}break}if(g){h.preventDefault()}});if(e.hasClass("outscreen")){$PBJQ("body").toggleClass("active-more-sites");var b=$PBJQ(".view-all-sites-btn:visible");var d=b.height()+5;if(b.length>0){b.css("z-index",1005);var c=b.offset().top-$PBJQ(window).scrollTop()+d;var f=$PBJQ("body").outerWidth()-(b.offset().left+b.outerWidth());if($PBJQ("html").attr("dir")!=="rtl"){e.css("top",c).css("right",f)}else{e.css("top",c).css("left",$PBJQ("body").outerWidth()-f)}}e.toggleClass("outscreen");a-=c;a-=parseInt(e.css("padding-bottom"),20);if(MorpheusViewportHelper.isNonPhone()){$PBJQ("#txtSearch").focus()}createDHTMLMask(dhtml_view_sites);$PBJQ(".selectedTab").bind("click",function(g){dhtml_view_sites();return false});$PBJQ(".tab-pane:first").focus();$PBJQ(document).trigger("view-sites-shown")}else{$PBJQ("body").toggleClass("active-more-sites");$PBJQ("#selectSiteModal").toggleClass("outscreen");var b=$PBJQ(".view-all-sites-btn");b.css("z-index","auto");$PBJQ("#selectSite").attr("tabindex","-1");removeDHTMLMask();$PBJQ("#otherSiteTools").remove();$PBJQ(".selectedTab").unbind("click")}};if($PBJQ(window).width()<800){a=a*0.85}$PBJQ(".tab-pane").css("height",a);dhtml_view_sites()};function closeDrawer(){$PBJQ("#selectSiteModal").toggleClass("outscreen");removeDHTMLMask();$PBJQ("#selectSite").attr("tabindex","-1");$PBJQ("#otherSiteTools").remove();$PBJQ(".selectedTab").unbind("click");$PBJQ(".moreSitesLink").unbind("keydown");if($PBJQ(".view-all-sites-btn a:visible").length){$PBJQ(".view-all-sites-btn a").focus()}else{$PBJQ(".js-toggle-sites-nav").focus()}}function createDHTMLMask(a){$PBJQ("body").append('<div id="portalMask">&nbsp;</div>');$PBJQ("#portalMask").css("height",browserSafeDocHeight()).css({width:"100%","z-index":1000,top:0,left:0}).attr("tabindex",-1).bind("click",function(b){a();return false});$PBJQ("#portalMask").bgiframe()}function removeDHTMLMask(){$PBJQ("#portalMask").remove()}function showToolMenu(h){var g=h.attr("id");var a=g.replace(/!/g,"\\!").replace(/~/g,"\\~");$PBJQ(".toolMenus").removeClass("toolMenusActive").attr("aria-expanded","false");if($PBJQ("."+a).length){$PBJQ("#otherSiteTools").remove()}else{var c=$PBJQ('<ul id="otherSiteTools" role="menu" />').addClass(g);var f="/direct/site/"+g+"/pages.json";scroll(0,0);var e=parseInt($PBJQ("#maxToolsInt").text());var d=$PBJQ("#maxToolsText").text();var i=$PBJQ('<li class="otherSiteTool" ><span><a role="menuitem" tabindex="-1"><span class="Mrphs-toolsNav__menuitem--icon"> </span></a></span></li>');var b=i.clone();b.addClass("gotosite");b.find("a").attr("href",portal.portalPath+"/site/"+g).attr("title",d).append(d);b.find("a span").addClass("icon-sakai--see-all-tools");$PBJQ.getJSON(f,function(j){$PBJQ.each(j,function(l,m){if(!m.tools[0]){return true}if(l<e){var k=i.clone();k.find("a").attr("href",m.tools[0].url).attr("title",m.title).append(m.title);k.find("a span").addClass("icon-sakai--"+m.tools[0].toolId.replace(/\./gi,"-")).addClass("otherSiteToolIcon");if(m.toolpopup){k.find("a").attr("href",m.tools[0].url+"?sakai.popup=yes").attr("onclick","window.open("+m.toolpopupurl+"); return false")}c.append(k)}});if(j.length>e){c.append(b.clone())}$PBJQ("#otherSiteTools").remove();h.closest("li").append(c);h.closest("li").find("ul li a").first().focus();addArrowNavAndDisableTabNav($PBJQ("ul#otherSiteTools"));h.parent().find(".toolMenus").addClass("toolMenusActive").attr("aria-expanded","true")})}}$PBJQ(document).ready(function(){if($PBJQ("#eid").length===1){$PBJQ("#eid").focus()}$PBJQ(".js-toggle-sites-nav","#skipNav").on("click",dhtml_view_sites);$PBJQ("#show-all-sites, .view-all-sites-btn").on("click",dhtml_view_sites);var b=portal.siteTitle;if(b){if(portal.shortDescription){b=b+" ("+portal.shortDescription+")"}$PBJQ(".portletTitle h2").prepend('<span class="siteTitle">'+b+":</span> ")}$PBJQ("#txtSearch").keyup(function(d){if(d.keyCode==27){a()}if($PBJQ("#txtSearch").val().length>0){var e=$PBJQ("#txtSearch").val().toLowerCase();$PBJQ(".fav-sites-term, .fav-sites-entry").hide();var c=$PBJQ(".fav-sites-entry").filter(function(f,g){return($PBJQ(".fav-title a span.fullTitle",g).text().toLowerCase().indexOf(e)>=0)});c.show();c.closest(".fav-sites-term").show()}if($PBJQ("#txtSearch").val().length==0){a()}if($PBJQ("#otherSiteList li:visible").length<1&&$PBJQ(".otherSitesCategorList li:visible").length<1){$PBJQ(".norecords").remove();$PBJQ("#noSearchResults").fadeIn("slow")}});function a(){$PBJQ("#txtSearch").val("");$PBJQ(".fav-sites-term, .fav-sites-entry").show();$PBJQ("#noSearchResults").hide();$PBJQ("#txtSearch").focus()}$PBJQ("#otherSiteSearchClear").on("click",function(){a()});$PBJQ("#presenceToggle").click(function(c){c.preventDefault();$PBJQ("#presenceArea").toggle()});$PBJQ(".trayPopupClose").click(function(c){c.preventDefault();$PBJQ(this).closest(".trayPopup").hide()});if($PBJQ("a.tool-directurl").length){$PBJQ("a.tool-directurl").cluetip({local:true,arrows:true,cluetipClass:"jtip",sticky:true,cursor:"pointer",activation:"click",closePosition:"title",closeText:'<img src="/library/image/silk/cross.png" alt="close">'})}});$PBJQ(document).ready(function(e){var n=true;var v=undefined;var z=[];var g=$PBJQ("#max-favorite-entries").text().trim();var x=false;var l=$PBJQ("#selectSite");var r=$PBJQ("#otherSitesCategorWrap");var m=$PBJQ("#organizeFavorites");var o={};$PBJQ(".site-favorite-btn",r).each(function(A,B){o[$PBJQ(B).attr("data-site-id")]=$PBJQ(B).parent()});var b={favorite:{markup:'<i class="site-favorite-icon site-favorite"></i>'},nonfavorite:{markup:'<i class="site-favorite-icon site-nonfavorite"></i>'},myworkspace:{markup:'<i class="site-favorite-icon site-workspace site-favorite"></i>'}};var d=function(A){$PBJQ.ajax({url:"/portal/favorites/list",method:"GET",dataType:"json",success:function(B){n=B.autoFavoritesEnabled;z=B.favoriteSiteIds.filter(function(D,C){return D!=""});if(v==undefined){v=z}A(z)}})};var p=function(A,C){var B=b[C];$PBJQ(A).data("favorite-state",C);if(C==="favorite"){$PBJQ(A).attr("title",$PBJQ("#removeFromFavoritesText").text().replace("[site]",$PBJQ(A).parent().find("span.fullTitle").text()))}else{if(C==="nonfavorite"){$PBJQ(A).attr("title",$PBJQ("#addToFavoritesText").text().replace("[site]",$PBJQ(A).parent().find("span.fullTitle").text()))}else{$PBJQ(A).attr("title",null)}}$PBJQ(A).empty().append($PBJQ(B.markup))};var f=function(){var A=$PBJQ(".fav-sites-entry .site-favorite",r).length;$PBJQ(".favoriteCount",l).text("("+A+")");if(A>g){$PBJQ(".favoriteCountAndWarning").addClass("maxFavoritesReached")}else{$PBJQ(".favoriteCountAndWarning").removeClass("maxFavoritesReached")}};var i=function(){$PBJQ(".favorites-select-all-none",r).each(function(A,C){var E=$PBJQ(C).closest(".fav-sites-term");var B=E.find(".fav-sites-entry:not(.my-workspace)").length;var D=E.find(".fav-sites-entry .site-favorite").length;if(B==0){$PBJQ(C).hide()}else{if(D==B){$PBJQ(C).data("favorite-state","favorite");$PBJQ(C).html(b.favorite.markup)}else{$PBJQ(C).data("favorite-state","nonfavorite");$PBJQ(C).html(b.nonfavorite.markup)}$PBJQ(C).show()}})};var s=function(){$PBJQ(".site-favorite-btn",r).empty();$PBJQ(".favorites-select-all-none",r).empty()};var k=function(A){$PBJQ(".site-favorite-btn",r).each(function(B,C){var D=$PBJQ(C).attr("data-site-id");if($PBJQ(C).closest(".my-workspace").length>0){p(C,"myworkspace")}else{if($PBJQ.inArray(D,A)>=0){p(C,"favorite")}else{p(C,"nonfavorite")}}});$PBJQ(".favorites-help-text").hide();if(n){$PBJQ(".favorites-help-text.autofavorite-enabled").show()}else{$PBJQ(".favorites-help-text.autofavorite-disabled").show()}i();f();x=true};var w=function(){return $PBJQ(".site-favorite-btn",r).has(".site-favorite").map(function(){return $PBJQ(this).attr("data-site-id")}).toArray()};var h=function(A){if(q){x=false;s()}if(!A){A=0}if(q&&A<100){setTimeout(function(){h(A+1)},50)}else{d(k)}};var y=function(B,A){if(B.length!=A.length){return false}for(var C=0;C<B.length;C++){if(B[C]!=A[C]){return false}}return true};var j=function(){if(y(z,v)){$PBJQ(".moresites-refresh-notification").remove();return}if($PBJQ(".moresites-refresh-notification").length>0){return}var A=$PBJQ('<div class="moresites-refresh-notification" />').html($PBJQ("#refreshNotificationText").html());$PBJQ("#loginLinks").prepend(A);A.css("top",($PBJQ(".Mrphs-siteHierarchy").offset().top)+"px")};var q=false;var u=[];var t=function(A){var B;while(u.length>0){B=u.shift()}if(B){$PBJQ.ajax({url:"/portal/favorites/update",method:"POST",data:{userFavorites:JSON.stringify(B),},error:A,complete:t})}else{q=false}};var a=function(B){if(!x){return}if(!B){B=function(){}}var A=w();A=A.sort(function(E,D){if(z.indexOf(E)===-1){return 1}else{if(z.indexOf(D)===-1){return -1}else{return z.indexOf(E)-z.indexOf(D)}}});var C={favoriteSiteIds:A,autoFavoritesEnabled:n,};u.push(C);if(q){}else{q=true;t(B)}z=A;j()};var c=function(E){if(v&&v.indexOf(E)>-1){var A=v.indexOf(E);var C=false;for(var F=A-1;F>=0;F--){var D=v[F];var B=z.indexOf(D);if(B>=0&&B<A){z.splice(B+1,0,E);C=true;break}}if(!C){z.splice(A,0,E)}}};$PBJQ(r).on("click",".site-favorite-btn",function(){var B=this;var D=$PBJQ(B).attr("data-site-id");var A=$PBJQ(B).data("favorite-state");if(A==="myworkspace"){return}var C;if(A==="favorite"){C="nonfavorite"}else{C="favorite"}if(C=="favorite"){c(D)}p(B,C);i();f();a(function(){h()})});$PBJQ(r).on("click",".favorites-select-all-none",function(){var B=$PBJQ(this).data("favorite-state");var A=$PBJQ(this).closest(".fav-sites-term").find(".fav-sites-entry:not(.my-workspace) .site-favorite-btn");var C;if(B=="favorite"){C="nonfavorite"}else{C="favorite"}A.each(function(D,E){p($PBJQ(E),C)});f();i();a(function(){h()})});$PBJQ(l).on("click",".tab-btn",function(){$PBJQ(".tab-btn",l).removeClass("active").attr("aria-selected","false").attr("tabindex","-1");$PBJQ(this).addClass("active").attr("aria-selected","true").attr("tabindex","0");var A=$PBJQ(this).data("tab-target");$PBJQ(".tab-box").hide();$PBJQ(l).trigger("tab-shown",A);$PBJQ("#"+A).show()});$PBJQ(l).on("keydown",".tab-btn",function(A){if(A.keyCode==32){$PBJQ(this).click();A.preventDefault()}if(A.keyCode==37){$PBJQ("[aria-selected=true]").prev().click().focus();A.preventDefault()}if(A.keyCode==38){$PBJQ("[aria-selected=true]").prev().click().focus();A.preventDefault()}if(A.keyCode==39){$PBJQ("[aria-selected=true]").next().click().focus();A.preventDefault()}if(A.keyCode==40){$PBJQ("[aria-selected=true]").next().click().focus();A.preventDefault()}});$PBJQ(document).on("view-sites-shown",function(){h()});$PBJQ(l).on("tab-shown",function(D,A){if(A==="organizeFavorites"){var C=$PBJQ("#organizeFavoritesList");C.empty();$PBJQ("#noFavoritesToShow").hide();$PBJQ("#favoritesToShow").hide();$PBJQ("#otherSiteTools").remove();$PBJQ("#organizeFavoritesPurgatoryList").empty();$PBJQ.each(z,function(F,H){if(!o[H]){return}if($PBJQ(o[H]).hasClass("my-workspace")){return}var G=o[H].clone(false);G.addClass("organize-favorite-item").data("site-id",H);var E=$PBJQ('<a href="javascript:void(0);" class="fav-drag-handle"><i class="fa fa-bars"></i></a>');$PBJQ(".toolMenus",G).remove();G.append(E);C.append(G);G.show()});if(C.find("li").length==0){$PBJQ("#noFavoritesToShow").show()}else{$PBJQ("#favoritesToShow").show()}var B=function(){var E=$PBJQ(".organize-favorite-item");E.removeClass("site-favorite-is-past-max");$PBJQ(".favorites-max-marker").remove();$PBJQ.each(E,function(G,F){if(G>=g){$PBJQ(F).addClass("site-favorite-is-past-max")}if(G==g){$PBJQ(F).before($PBJQ('<li class="favorites-max-marker"><i class="fa fa-warning warning-icon"></i> '+$PBJQ("#maxFavoritesLimitReachedText").text()+"</li>"))}})};B();C.keyboardSortable({items:"li:not(.favorites-max-marker)",handle:".fav-drag-handle",update:function(){B();z=C.find(".organize-favorite-item *[data-site-id]").map(function(){return $PBJQ(this).attr("data-site-id")}).toArray();a()}});C.disableSelection();$PBJQ("#autoFavoritesEnabled").attr("aria-checked",n);$PBJQ("#organizeFavorites .onoffswitch").show()}});$PBJQ(r).on("click",".toolMenus",function(A){A.preventDefault();showToolMenu($PBJQ(this));return false});$PBJQ(m).on("click",".site-favorite-btn",function(){var C=this;if($PBJQ(C).closest(".my-workspace").length>0){return}var A=$PBJQ(C).parent();var B;if($PBJQ(C).closest("#organizeFavoritesList").length==0){var E=$PBJQ(C).attr("data-site-id");c(E);var D=z.indexOf(E);if(D==0){$PBJQ("#organizeFavoritesList").prepend(A)}else{if(D>0){$PBJQ("#organizeFavoritesList li:nth-child("+D+")").after(A)}else{$PBJQ("#organizeFavoritesList").append(A)}}B="favorite"}else{$PBJQ("#organizeFavoritesPurgatoryList").append(A);B="nonfavorite"}p(C,B);p(o[$PBJQ(C).attr("data-site-id")].find(".site-favorite-btn"),B);i();f();a(function(){h()})});$PBJQ("#autoFavoritesEnabled").click(function(){$PBJQ(this).attr("aria-checked",function(A,B){var C=(B==="true");return String(!C)});$PBJQ(this).trigger("change")});$PBJQ("#autoFavoritesEnabled").on("change",function(){n=$PBJQ(this).attr("aria-checked")==="true";$PBJQ(".favorites-help-text").hide();if(n){$PBJQ(".favorites-help-text.autofavorite-enabled").show()}else{$PBJQ(".favorites-help-text.autofavorite-disabled").show()}a();return true});$PBJQ(".otherSitesMenuClose").on("click",function(){dhtml_view_sites()})});