function userNavEscHandler(a){if(a.keyCode===27){toggleUserNav(a)}}function toggleUserNav(b){b.preventDefault();$PBJQ(".Mrphs-userNav__subnav").toggleClass("is-hidden");if(!$PBJQ(".Mrphs-userNav__subnav").hasClass("is-hidden")){var a=$PBJQ('<div class="user-dropdown-overlay" />');a.on("click",function(c){toggleUserNav(c)});$PBJQ("body").prepend(a);$PBJQ(document).on("keyup",userNavEscHandler)}else{$PBJQ(".user-dropdown-overlay").remove();$PBJQ(document).off("keyup",userNavEscHandler)}}$PBJQ("#loginLink1").click(function(a){if($PBJQ(this).attr("data-warning")!==""&&!confirm($PBJQ(this).attr("data-warning"))){a.preventDefault()}});$PBJQ(".js-toggle-user-nav a#loginUser > .Mrphs-userNav__drop-btn","#loginLinks").on("click",toggleUserNav);$PBJQ(".js-toggle-user-nav .Mrphs-userNav__drop-btn","#loginLinks").on("click",toggleUserNav);$PBJQ(".Mrphs-userNav__pic-changer").on("click",function(b){var k=$PBJQ(this);if(!window.FileReader){$PBJQ(k.data("profileLink")).trigger("click");return true}if(!$PBJQ.fn.modal){$PBJQ(k.data("profileLink")).trigger("click");return true}b.preventDefault();b.stopImmediatePropagation();function i(){l.find(".modal-body .alert").hide();$PBJQ.ajax("/direct/profile-image/remove",{data:{sakai_csrf_token:sakai_csrf_token},type:"POST",dataType:"json",success:function(q,r,p){if(q.status=="SUCCESS"){g();$PBJQ("#cropToolbar").hide()}else{$PBJQ("#remove-error").show()}}})}function d(){a.find("> img").cropper({aspectRatio:1/1,checkCrossOrigin:false,guides:true,minContainerWidth:300,minContainerHeight:300,autoCropArea:1,viewMode:1,dragMode:"move"})}function e(){var p=$PBJQ("#cropToolbar").show();if(!portal.pictureToolbarSetup){$PBJQ(".profile-image-zoom-in",p).on("click",function(){a.find("> img").cropper("zoom",0.1)});$PBJQ(".profile-image-zoom-out",p).on("click",function(){a.find("> img").cropper("zoom",-0.1)});$PBJQ(".profile-image-pan-up",p).on("click",function(){a.find("> img").cropper("move",0,-10)});$PBJQ(".profile-image-pan-down",p).on("click",function(){a.find("> img").cropper("move",0,10)});$PBJQ(".profile-image-pan-left",p).on("click",function(){a.find("> img").cropper("move",10,0)});$PBJQ(".profile-image-pan-right",p).on("click",function(){a.find("> img").cropper("move",-10,0)});$PBJQ(".profile-image-rotate",p).on("click",function(){a.find("> img").cropper("clear");a.find("> img").cropper("rotate",90);a.find("> img").cropper("crop")});portal.pictureToolbarSetup=true}}function f(p){a.show();a.find("> img").cropper("clear");a.find("> img").cropper("replace",p);j.removeProp("disabled");e()}function c(){$PBJQ.getJSON("/direct/profile-image/details?_="+new Date().getTime(),function(p){if(p.status=="SUCCESS"){if(!p.isDefault){f(p.url+"?_="+new Date().getTime());$PBJQ(".remove-profile-image").on("click",function(){i()})}}sakai_csrf_token=p.csrf_token})}function n(){return new Promise(function(p){p(a.find("> img").cropper("getCroppedCanvas",{width:200,height:200}).toDataURL())})}function g(){var r=$PBJQ("#loginUser > .Mrphs-userNav__submenuitem--profilepicture");var q=r.parent();r.detach();var s=new Date();var p="background-image: url(/direct/profile/"+portal.user.id+"/image/thumb?"+s.getTime()+")";r.attr("style",p);q.prepend(r);r=$PBJQ(".Mrphs-userNav__submenuitem--profilelink > .Mrphs-userNav__submenuitem--profilepicture");q=r.parent();r.detach();r.attr("style",p);q.prepend(r);$PBJQ("#profileImageUpload").modal("hide")}function m(p){l.find(".modal-body .alert").hide();$PBJQ.ajax("/direct/profile-image/upload",{data:{sakai_csrf_token:sakai_csrf_token,base64:p},type:"POST",dataType:"json",success:function(r,s,q){if(r.status=="SUCCESS"){g()}else{$PBJQ("#upload-error").show()}}})}var l=$PBJQ("#profileImageUpload");var o=false;l.on("shown.bs.modal",function(){c()});l.modal({width:320});$PBJQ("#remove-error").hide();$PBJQ("#upload-error").hide();var j=l.find("#save");var h=$PBJQ("#file");var a=$PBJQ("#cropme").hide();d();h.on("change",function(){var q=$PBJQ(this);if(this.files&&this.files[0]){var p=new FileReader();p.onload=function(r){f(r.target.result)};p.readAsDataURL(this.files[0])}else{throw"Browser does not support FileReader"}});j.on("click",function(p){n().then(function(q){m(q.replace(/^data:image\/(png|jpg);base64,/,""))})});return false});var header=$PBJQ(".Mrphs-topHeader");var currentHeaderWidth=-1;$PBJQ(document).ready(function(){$PBJQ(header).data("sticked",false);if($PBJQ(".Mrphs-hierarchy--parent-sites").length>0&&$PBJQ(window).width()<=800){$PBJQ("#content").css("margin-top",(parseInt($PBJQ("#content").css("margin-top").replace("px",""))+$PBJQ(".Mrphs-hierarchy--parent-sites").outerHeight(true))+"px")}$PBJQ(window).resize(function(){currentHeaderWidth=$PBJQ(".Mrphs-mainHeader").width()});$PBJQ(window).scroll(function(){var b=0;var a=(($PBJQ(document).height()-$PBJQ(window).height())>$PBJQ(header).height())===true;if($PBJQ(window).scrollTop()>0){if($PBJQ(header).data("sticked")===false&&a===true){$PBJQ(header).data("sticked",true);$PBJQ(".Mrphs-mainHeader").addClass("is-fixed")}}else{$PBJQ(".Mrphs-mainHeader").removeClass("is-fixed");$PBJQ(header).data("sticked",false)}});currentHeaderWidth=$PBJQ(".Mrphs-mainHeader").width();$PBJQ(".Mrphs-headerLogo").on("click",function(){document.body.scrollTop=0;document.body.scrollLeft=0;$PBJQ(window).trigger("scroll")})});